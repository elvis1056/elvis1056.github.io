**3NF 的核心概念**：

> 表格中的每個非鍵屬性都必須依賴於鍵（主鍵），完整的鍵，以及**除了鍵之外什麼都不依賴**。

> 非鍵欄位之間不能互相依賴，所有非鍵欄位都只能直接依賴主鍵。

- **遞移依賴（Transitive Dependency）**：A → B → C 這種間接依賴關係
- 3NF 就是要消除遞移依賴

---

## 什麼是遞移依賴？

想像一個關係鏈：

```
主鍵 → 欄位A → 欄位B
```

- 主鍵可以決定欄位A
- 欄位A可以決定欄位B
- 所以主鍵可以「間接」決定欄位B

這就是**遞移依賴**，違反 3NF！

---

## 電商平台實例

### ❌ 違反 3NF 的設計

假設我們有一個訂單表：

```
訂單表
訂單編號(PK) | 客戶編號 | 客戶姓名 | 客戶電話    | 客戶城市 | 城市郵遞區號 | 訂單金額
-------------|----------|----------|------------|----------|-------------|----------
ORD001       | C001     | 王小明   | 0912345678 | 台北市   | 100         | 50000
ORD002       | C002     | 李小華   | 0923456789 | 新北市   | 220         | 30000
ORD003       | C001     | 王小明   | 0912345678 | 台北市   | 100         | 25000
ORD004       | C003     | 張大同   | 0934567890 | 台中市   | 400         | 40000
```

**先檢查是否符合 2NF：**

- 主鍵：`訂單編號`（單一主鍵，不是複合的）
- 所以自動符合 2NF ✅（因為不可能有部分依賴）

**但是違反 3NF！為什麼？**

讓我們分析依賴關係：

```
訂單編號 → 客戶編號     ✅ 直接依賴主鍵
訂單編號 → 訂單金額     ✅ 直接依賴主鍵

客戶編號 → 客戶姓名     ⚠️ 客戶姓名依賴於客戶編號
客戶編號 → 客戶電話     ⚠️ 客戶電話依賴於客戶編號
客戶編號 → 客戶城市     ⚠️ 客戶城市依賴於客戶編號

客戶城市 → 城市郵遞區號 ⚠️ 郵遞區號依賴於城市
```

**發現遞移依賴：**

1. **第一個遞移依賴鏈**：

```
訂單編號 → 客戶編號 → 客戶姓名
訂單編號 → 客戶編號 → 客戶電話
訂單編號 → 客戶編號 → 客戶城市
```

- 客戶的資訊不是直接依賴訂單編號
- 而是透過「客戶編號」這個中介

2. **第二個遞移依賴鏈**：

```
訂單編號 → 客戶編號 → 客戶城市 → 城市郵遞區號
```

- 郵遞區號根本不依賴訂單編號
- 它只依賴城市名稱

---

### 這會造成什麼問題？

**1. 資料重複（Redundancy）**

```
ORD001 和 ORD003 都是 C001 客戶下的訂單
→ 王小明的姓名、電話、城市都重複記錄了兩次
```

**2. 更新異常（Update Anomaly）**

```
如果王小明搬家到新北市：
→ 需要更新所有他的訂單記錄（ORD001 和 ORD003）
→ 如果只改了其中一個，就會資料不一致
```

**3. 插入異常（Insert Anomaly）**

```
無法單獨記錄新客戶資訊（必須等他下訂單才能記錄）
```

**4. 刪除異常（Delete Anomaly）**

```
如果刪除 ORD002（李小華唯一的訂單）
→ 李小華的所有資訊都消失了
```

**5. 城市郵遞區號的問題**

```
台北市的郵遞區號 100 在每筆台北市的訂單中都重複
如果郵遞區號調整，需要更新所有相關記錄
```

---

### ✅ 符合 3NF 的正確設計

將資料拆分成多個表格，消除遞移依賴：

**訂單表（Orders）**

```
訂單編號(PK) | 客戶編號(FK) | 訂單日期   | 訂單金額
-------------|--------------|-----------|----------
ORD001       | C001         | 2025-11-01| 50000
ORD002       | C002         | 2025-11-02| 30000
ORD003       | C001         | 2025-11-03| 25000
ORD004       | C003         | 2025-11-04| 40000
```

- 只保留直接依賴訂單的資訊
- 客戶編號作為外鍵參照客戶表

**客戶表（Customers）**

```
客戶編號(PK) | 客戶姓名 | 客戶電話    | 城市編號(FK)
-------------|----------|------------|-------------
C001         | 王小明   | 0912345678 | CITY01
C002         | 李小華   | 0923456789 | CITY02
C003         | 張大同   | 0934567890 | CITY03
```

- 客戶的基本資料獨立出來
- 城市編號作為外鍵參照城市表

**城市表（Cities）**

```
城市編號(PK) | 城市名稱 | 郵遞區號
-------------|----------|----------
CITY01       | 台北市   | 100
CITY02       | 新北市   | 220
CITY03       | 台中市   | 400
```

- 城市資訊獨立管理
- 消除了「城市 → 郵遞區號」的遞移依賴

**現在的依賴關係：**

```
訂單表：
  訂單編號 → 客戶編號  ✅
  訂單編號 → 訂單金額  ✅

客戶表：
  客戶編號 → 客戶姓名  ✅
  客戶編號 → 客戶電話  ✅
  客戶編號 → 城市編號  ✅

城市表：
  城市編號 → 城市名稱  ✅
  城市編號 → 郵遞區號  ✅
```

每個非鍵欄位都只直接依賴於自己表格的主鍵，沒有遞移依賴！

---

## 另一個電商例子：商品與分類

### ❌ 違反 3NF

```
商品表
商品編號(PK) | 商品名稱  | 分類編號 | 分類名稱 | 分類描述           | 單價
-------------|-----------|----------|----------|-------------------|------
P001         | iPhone15  | CAT01    | 手機     | 智慧型手機相關商品 | 30000
P002         | AirPods   | CAT02    | 耳機     | 音訊設備          | 5000
P003         | 充電線    | CAT03    | 配件     | 手機周邊配件      | 500
P004         | iPhone14  | CAT01    | 手機     | 智慧型手機相關商品 | 25000
```

**遞移依賴問題：**

```
商品編號 → 分類編號 → 分類名稱
商品編號 → 分類編號 → 分類描述
```

- 分類名稱和分類描述不是依賴商品編號
- 而是依賴分類編號

**問題：**

- 「手機」的分類名稱和描述在 P001 和 P004 中重複
- 如果要修改「手機」分類的描述，需要更新所有手機類商品

---

### ✅ 符合 3NF

**商品表（Products）**

```
商品編號(PK) | 商品名稱  | 分類編號(FK) | 單價
-------------|-----------|--------------|------
P001         | iPhone15  | CAT01        | 30000
P002         | AirPods   | CAT02        | 5000
P003         | 充電線    | CAT03        | 500
P004         | iPhone14  | CAT01        | 25000
```

**分類表（Categories）**

```
分類編號(PK) | 分類名稱 | 分類描述
-------------|----------|-------------------
CAT01        | 手機     | 智慧型手機相關商品
CAT02        | 耳機     | 音訊設備
CAT03        | 配件     | 手機周邊配件
```

**優點：**

- 分類資訊只記錄一次
- 修改分類描述只需更新分類表
- 可以獨立管理商品分類

---

## 更複雜的例子：員工與部門

### ❌ 違反 3NF

```
員工表
員工編號(PK) | 員工姓名 | 部門編號 | 部門名稱   | 部門主管 | 部門電話    | 薪資
-------------|----------|----------|-----------|----------|------------|------
E001         | 王小明   | D01      | 業務部    | 李經理   | 02-1234567 | 50000
E002         | 李小華   | D01      | 業務部    | 李經理   | 02-1234567 | 45000
E003         | 張大同   | D02      | 技術部    | 陳經理   | 02-7654321 | 60000
E004         | 陳小美   | D02      | 技術部    | 陳經理   | 02-7654321 | 55000
```

**遞移依賴：**

```
員工編號 → 部門編號 → 部門名稱
員工編號 → 部門編號 → 部門主管
員工編號 → 部門編號 → 部門電話
```

---

### ✅ 符合 3NF

**員工表（Employees）**

```
員工編號(PK) | 員工姓名 | 部門編號(FK) | 薪資
-------------|----------|--------------|------
E001         | 王小明   | D01          | 50000
E002         | 李小華   | D01          | 45000
E003         | 張大同   | D02          | 60000
E004         | 陳小美   | D02          | 55000
```

**部門表（Departments）**

```
部門編號(PK) | 部門名稱 | 部門主管 | 部門電話
-------------|----------|----------|------------
D01          | 業務部   | 李經理   | 02-1234567
D02          | 技術部   | 陳經理   | 02-7654321
```

---

## 如何判斷是否違反 3NF？

**步驟：**

1. **確認已符合 2NF**

2. **找出所有非鍵欄位**

3. **對每個非鍵欄位問：「它是直接依賴主鍵，還是透過其他欄位間接依賴？」**

4. **畫出依賴圖**
   - 如果是：主鍵 → 欄位X → 欄位Y
   - 就違反 3NF

5. **解決方法**：
   - 把有遞移依賴的欄位拆到新表格
   - 讓每個欄位都直接依賴主鍵

---

## 3NF 口訣記憶

英文版（經典）：

> **"The key, the whole key, and nothing but the key, so help me Codd"**
> （依賴於鍵，完整的鍵，以及除了鍵之外什麼都不依賴）

- "The key" → 1NF（有主鍵）
- "The whole key" → 2NF（完全依賴整個主鍵，沒有部分依賴）
- "Nothing but the key" → 3NF（只依賴主鍵，沒有遞移依賴）

---

## 3NF 總結

**簡單記憶法：**

- 2NF 處理「部分依賴」（複合主鍵的問題）
- 3NF 處理「遞移依賴」（非鍵欄位之間的依賴）

**實務判斷：**

- 如果一個非鍵欄位可以決定另一個非鍵欄位 → 違反 3NF
- 如果所有非鍵欄位都只依賴主鍵，不互相依賴 → 符合 3NF

**3NF 的好處：**

- ✅ 最小化資料重複
- ✅ 避免更新異常
- ✅ 更容易維護資料一致性
- ✅ 更靈活的資料結構

**實務建議：**

- 大多數應用系統達到 3NF 就足夠了
- 3NF 是效能和正規化之間的良好平衡點
