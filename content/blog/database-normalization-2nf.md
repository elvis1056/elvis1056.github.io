## 什麼是 2NF？

**2NF 的核心概念**：

> 表格中的每個非鍵屬性都必須**完全依賴於整個主鍵**，而不是只依賴主鍵的一部分。

這個規則只適用於**複合主鍵**（由多個欄位組成的主鍵）的情況。

---

## 電商平台實例

### ❌ 違反 2NF 的設計

假設我們有一個訂單明細表：

```
訂單明細表
訂單編號(PK) | 商品編號(PK) | 商品名稱 | 商品分類 | 數量 | 單價 | 客戶姓名 | 客戶電話
-------------|--------------|----------|----------|------|------|----------|------------
ORD001       | P001         | iPhone15 | 手機     | 1    | 30000| 王小明   | 0912345678
ORD001       | P002         | AirPods  | 耳機     | 2    | 5000 | 王小明   | 0912345678
ORD002       | P001         | iPhone15 | 手機     | 1    | 30000| 李小華   | 0923456789
ORD002       | P003         | 充電線   | 配件     | 3    | 500  | 李小華   | 0923456789
```

**這個設計的主鍵是什麼？**

- 複合主鍵：`(訂單編號, 商品編號)`
- 因為一張訂單可以有多個商品，一個商品也可以出現在多張訂單中

**違反 2NF 的問題在哪？**

讓我們分析每個欄位依賴於什麼：

```
| 欄位     | 依賴於               | 是否完全依賴整個主鍵？                        |
| -------- | -------------------- | --------------------------------------------- |
| 數量     | (訂單編號, 商品編號) | ✅ 是（需要知道是哪張訂單的哪個商品）         |
| 單價     | (訂單編號, 商品編號) | ✅ 是（訂單時的價格可能不同）                 |
| 商品名稱 | **只依賴商品編號**   | ❌ **部分依賴**（只要知道商品編號就知道名稱） |
| 商品分類 | **只依賴商品編號**   | ❌ **部分依賴**                               |
| 客戶姓名 | **只依賴訂單編號**   | ❌ **部分依賴**                               |
| 客戶電話 | **只依賴訂單編號**   | ❌ **部分依賴**                               |
```

**這會造成什麼問題？**

1. **資料重複**：
   - iPhone15 的名稱和分類在每筆訂單中都重複
   - 姓名和電話在同一訂單的每個商品都重複

2. **更新異常**：
   - 如果 iPhone15 改名為 "iPhone 15 Pro"，需要更新所有相關記錄
   - 如果改錯其中一筆，就會資料不一致

3. **插入異常**：
   - 無法單獨記錄新商品資訊（因為必須有訂單才能插入）

4. **刪除異常**：
   - 如果刪除 ORD002 的所有明細，P003 充電線的資訊也跟著消失

---

### ✅ 符合 2NF 的正確設計

將資料拆分成多個表格，消除部分依賴：

**訂單表（Orders）**

```
訂單編號(PK) | 客戶姓名 | 客戶電話    | 訂單日期
-------------|----------|-------------|------------
ORD001       | 王小明   | 0912345678  | 2025-11-01
ORD002       | 李小華   | 0923456789  | 2025-11-02
```

- 所有欄位都完全依賴於 `訂單編號`

**商品表（Products）**

```
商品編號(PK) | 商品名稱  | 商品分類 | 標準售價
-------------|-----------|----------|----------
P001         | iPhone15  | 手機     | 30000
P002         | AirPods   | 耳機     | 5000
P003         | 充電線    | 配件     | 500
```

- 所有欄位都完全依賴於 `商品編號`

**訂單明細表（Order_Items）**

```
訂單編號(PK,FK) | 商品編號(PK,FK) | 數量 | 實際單價
----------------|-----------------|------|----------
ORD001          | P001            | 1    | 30000
ORD001          | P002            | 2    | 5000
ORD002          | P001            | 1    | 30000
ORD002          | P003            | 3    | 500
```

- 所有欄位都完全依賴於複合主鍵 `(訂單編號, 商品編號)`

---

## 另一個電商例子：促銷活動

### ❌ 違反 2NF

```
促銷商品表
活動編號(PK) | 商品編號(PK) | 活動名稱       | 活動開始日期 | 商品名稱  | 折扣價
-------------|--------------|----------------|-------------|-----------|--------
PROMO01      | P001         | 雙11大促       | 2025-11-11  | iPhone15  | 25000
PROMO01      | P002         | 雙11大促       | 2025-11-11  | AirPods   | 4000
PROMO02      | P001         | 週年慶         | 2025-12-01  | iPhone15  | 27000
```

**問題分析：**

- `活動名稱`、`活動開始日期` 只依賴 `活動編號`（部分依賴）
- `商品名稱` 只依賴 `商品編號`（部分依賴）
- 只有 `折扣價` 完全依賴 `(活動編號, 商品編號)`

### ✅ 符合 2NF

**促銷活動表**

```
活動編號(PK) | 活動名稱  | 活動開始日期 | 活動結束日期
-------------|-----------|-------------|-------------
PROMO01      | 雙11大促  | 2025-11-11  | 2025-11-11
PROMO02      | 週年慶    | 2025-12-01  | 2025-12-31
```

**商品表**（已存在）

```
商品編號(PK) | 商品名稱  | 標準售價
-------------|-----------|----------
P001         | iPhone15  | 30000
P002         | AirPods   | 5000
```

**促銷商品表**

```
活動編號(PK,FK) | 商品編號(PK,FK) | 折扣價
----------------|-----------------|--------
PROMO01         | P001            | 25000
PROMO01         | P002            | 4000
PROMO02         | P001            | 27000
```

---

## 2NF 總結

**簡單記憶法：**

- 如果主鍵只有一個欄位 → 自動符合 2NF（因為無法「部分依賴」）
- 如果主鍵是複合的 → 檢查每個非鍵欄位是否依賴**整個**主鍵

**實務判斷步驟：**

1. 找出表格的主鍵（可能是單一或複合）
2. 如果是複合主鍵，檢查每個非鍵欄位
3. 如果某欄位只依賴主鍵的一部分 → 違反 2NF
4. 解決方法：把部分依賴的欄位拆到新表格

**2NF 的好處：**

- ✅ 減少資料重複
- ✅ 避免更新異常
- ✅ 避免插入/刪除異常
- ✅ 資料結構更清晰
